package org.jmedikit.plugin.gui;


import org.eclipse.e4.tools.services.IResourcePool;
import org.eclipse.swt.SWT;
import org.eclipse.swt.events.FocusEvent;
import org.eclipse.swt.events.FocusListener;
import org.eclipse.swt.events.SelectionEvent;
import org.eclipse.swt.events.SelectionListener;
import org.eclipse.swt.events.ShellEvent;
import org.eclipse.swt.events.ShellListener;
import org.eclipse.swt.graphics.Image;
import org.eclipse.swt.layout.FillLayout;
import org.eclipse.swt.layout.GridData;
import org.eclipse.swt.layout.GridLayout;
import org.eclipse.swt.widgets.Button;
import org.eclipse.swt.widgets.Canvas;
import org.eclipse.swt.widgets.Composite;
import org.eclipse.swt.widgets.Display;
import org.eclipse.swt.widgets.Event;
import org.eclipse.swt.widgets.Label;
import org.eclipse.swt.widgets.Listener;
import org.eclipse.swt.widgets.Shell;
import org.eclipse.swt.widgets.Slider;
import org.eclipse.swt.widgets.Text;
import org.eclipse.swt.widgets.ToolBar;
import org.eclipse.swt.widgets.ToolItem;
import org.jmedikit.lib.core.DicomTreeItem;
import org.jmedikit.lib.util.ImageProvider;
import org.jmedikit.plugin.gui.tools.AToolFactory;


public class ImageViewComposite extends Composite{
	
	private DicomTreeItem item;
	
	private DicomCanvas canvas;
	
	private Display fullScreenDisplay;
	
	private Label label;
	
	private Composite parent, titlebar, canvasContainer, controls;

	private Slider slider;
	
	private ToolItem close, fullscreen;
	
	private Text percentage;
	
	private IResourcePool imageResource;
	
	private ImageViewPart rootPart;
	
	private Image closeImg, fullscreenImg, fullscreenExitImg;
	
	private boolean isFullscreen;
	/**
	 * Create the composite.
	 * @param parent
	 * @param style
	 */
	public ImageViewComposite(Composite parent, int style, String title, DicomTreeItem selection, IResourcePool pool, ImageViewPart rootPart) {
		super(parent, style);
		this.parent = parent;
		this.imageResource = pool;
		this.rootPart = rootPart;
		this.item = selection;
		isFullscreen = false;
		
		closeImg = imageResource.getImageUnchecked(ImageProvider.CLOSE_DARK_BUTTON);
		fullscreenImg = imageResource.getImageUnchecked(ImageProvider.IMAGEVIEW_FULLSCREEN);
		fullscreenExitImg = imageResource.getImageUnchecked(ImageProvider.IMAGEVIEW_FULLSCREEN_EXIT);
		
		GridLayout gridLayout = new GridLayout(2, false);
		gridLayout.marginHeight = 0;
		gridLayout.marginWidth = 0;
		gridLayout.horizontalSpacing = 0;
		setLayout(gridLayout);
		
		GridData data = new GridData(SWT.FILL, SWT.FILL, true, true, 0, 0);
		setLayoutData(data);

		canvasContainer = new Composite(this, SWT.NONE);
		canvasContainer.setLayoutData(new GridData(SWT.FILL, SWT.FILL, true, true, 0, 0));
		//canvasContainer.setLayout(new GridLayout(1, false));
		GridLayout canvasContainerLayout = new GridLayout(1, false);
		canvasContainerLayout.marginHeight = 0;
		canvasContainerLayout.marginWidth = 0;
		canvasContainerLayout.horizontalSpacing = 0;
		canvasContainer.setLayout(canvasContainerLayout);
		
		titlebar = new Composite(canvasContainer, SWT.NONE);
		GridData titlebarData = new GridData(SWT.FILL, SWT.FILL, true, false, 0, 0);
		titlebarData.heightHint = 40;
		GridLayout titlebarLayout = new GridLayout(1, false);
		titlebarLayout.marginHeight = 3;
		titlebarLayout.marginWidth = 3;
		titlebar.setLayout(titlebarLayout);
		titlebar.setLayoutData(titlebarData);
		
		label = new Label(titlebar, SWT.NONE);
		label.setLayoutData(new GridData(SWT.FILL, SWT.CENTER, true, true, 0, 0));
		label.setText(title);
		
		canvas = new DicomCanvas(canvasContainer, SWT.NO_BACKGROUND, selection);
		canvas.setLayoutData(new GridData(SWT.FILL, SWT.FILL, true, true, 0, 0));
		
		int controlsSizeWidth = 20;
		int controlsSiteHeight = 20;
		
		controls = new Composite(this, SWT.NONE);
		GridLayout controlsLayout = new GridLayout(1, false);
		GridData controlsLayoutData = new GridData(SWT.FILL, SWT.FILL, false, false, 0, 0);
		controlsLayoutData.widthHint = 20;
		controlsLayout.marginHeight = 0;
		controlsLayout.marginWidth = 0;
		controls.setLayout(controlsLayout);
		controls.setLayoutData(controlsLayoutData);
		
		ToolBar imageViewTools = new ToolBar(controls, SWT.FLAT | SWT.VERTICAL);
		//imageViewTools.setLayout(new GridLayout(1, false));
		//GridData toolbarData = new GridData(SWT.FILL, SWT.FILL, true, false, 0, 0);
		//toolbarData.widthHint = controlsSizeWidth;
		//imageViewTools.setLayoutData(toolbarData);
		
		
		close = new ToolItem(imageViewTools, SWT.NONE);
		close.setImage(closeImg);
		GridData gd_button_close = new GridData(SWT.CENTER, SWT.FILL, false, false, 0, 0);
		gd_button_close.widthHint = controlsSizeWidth;
		gd_button_close.heightHint = controlsSiteHeight;
		//close.setLayoutData(gd_button_close);
		//close.setImage(closeImg);
		
		fullscreen = new ToolItem(imageViewTools, SWT.NONE);
		fullscreen.setImage(fullscreenImg);
		GridData gd_button_fullscreen = new GridData(SWT.CENTER, SWT.FILL, false, false, 0, 0);
		gd_button_fullscreen.widthHint = controlsSizeWidth;
		gd_button_fullscreen.heightHint = controlsSiteHeight;
		//fullscreen.setLayoutData(gd_button_fullscreen);
		//fullscreen.setImage(fullscreenImg);
		
		slider = new Slider(controls, SWT.VERTICAL);
		GridData gd_slider = new GridData(SWT.FILL, SWT.FILL, true, true, 0, 0);
		gd_slider.widthHint = controlsSizeWidth;
		slider.setLayoutData(gd_slider);
		int sliderMaximum = selection.getChildren().size() > 0 ? selection.getChildren().size()-1 : 0;
		System.out.println(sliderMaximum);
		slider.setMaximum(sliderMaximum+slider.getThumb());
		
		
		
		
		/*minus = new Button(controls, SWT.NONE);
		GridData gd_button_1 = new GridData(SWT.RIGHT, SWT.FILL, false, true, 1, 1);
		gd_button_1.widthHint = 25;
		gd_button_1.heightHint = 25;
		minus.setLayoutData( gd_button_1);
		minus.setImage(minusDark);
		
		percentage = new Text(controls, SWT.BORDER | SWT.CENTER);
		percentage.setText("100");
		GridData gd_text = new GridData(SWT.RIGHT, SWT.CENTER, false, false, 1, 1);
		gd_text.heightHint = 15;
		gd_text.widthHint = 50;
		percentage.setLayoutData(gd_text);

		plus = new Button(controls, SWT.CENTER);
		GridData gd_button = new GridData(SWT.CENTER, SWT.FILL, false, true, 1, 1);
		gd_button.widthHint = 25;
		gd_button.heightHint = 25;
		plus.setLayoutData(gd_button);
		plus.setImage(plusDark);*/

		init();
	}

	private void initButtons(){
		
		close.addSelectionListener(new SelectionListener() {
			
			@Override
			public void widgetSelected(SelectionEvent e) {
				//ImageViewComposite.this.layout();
				dispose();
				parent.layout();
			}
			
			@Override
			public void widgetDefaultSelected(SelectionEvent e) {
				// TODO Auto-generated method stub
				
			}
		});
		
		fullscreen.addSelectionListener(new SelectionListener() {
			
			Shell fullScreenShell = new Shell(SWT.NO_TRIM);
			
			@Override
			public void widgetSelected(SelectionEvent e) {
				if(isFullscreen){
					isFullscreen = false;
					
					Shell current = Display.getCurrent().getActiveShell();
					ImageViewComposite.this.setParent(parent);
					ImageViewComposite.this.fullscreen.setImage(fullscreenImg);
					current.dispose();
					parent.layout(true, true);
				}
				else {
					isFullscreen = true;
					fullScreenShell.setLayout(new GridLayout(1, true));
					fullScreenShell.setLayoutData(new GridData(SWT.FILL, SWT.FILL, true, true, 0, 0));
					fullScreenShell.setBounds(Display.getDefault().getPrimaryMonitor().getBounds());

					ImageViewComposite.this.setParent(fullScreenShell);
					ImageViewComposite.this.fullscreen.setImage(fullscreenExitImg);
					
					fullScreenShell.setFullScreen(true);
					fullScreenShell.open();
					fullScreenShell.layout(true, true);
				}
			}
			
			@Override
			public void widgetDefaultSelected(SelectionEvent e) {
				widgetSelected(e);
			}
		});
		
		close.addListener(SWT.MouseUp, new Listener() {
			
			@Override
			public void handleEvent(Event event) {

				Shell shell = new Shell(SWT.NO_TRIM);

				
				
				
				//while(!shell.isDisposed()){
				//    if(!fullScreenDisplay.readAndDispatch())
				 //   	fullScreenDisplay.sleep();
				//  }
				//fullScreenDisplay.dispose();
				//System.out.println("Close clicked");
				
				//ImageViewComposite.this.layout();
				//dispose();
				//parent.layout();
			}
		});
		
		/*minus.addListener(SWT.MouseUp, new Listener() {
			
			@Override
			public void handleEvent(Event event) {
				
			}
		});
		
		minus.addFocusListener(new FocusListener() {
			
			@Override
			public void focusLost(FocusEvent e) {
				System.out.println("Minus lost");
			}
			
			@Override
			public void focusGained(FocusEvent e) {
				System.out.println("Minus gained");
			}
		});
		
		plus.addListener(SWT.MouseUp, new Listener() {
			
			public void handleEvent(Event event) {
				
			}
		});*/
	}
	
	private void initSlider(){
		System.out.println("initSlider");
		System.out.println("Get max "+slider.getMaximum());
		slider.addSelectionListener(new SelectionListener() {
			
			@Override
			public void widgetSelected(SelectionEvent e) {
				//painter.setIndex(slider.getSelection());
				canvas.setIndex(slider.getSelection());
			}
			
			@Override
			public void widgetDefaultSelected(SelectionEvent e) {
			}
		});
	}
	
	
	/*private void initText(){
		percentage.addListener(SWT.KeyUp, new Listener() {
			
			@Override
			public void handleEvent(Event event) {
				if(event.keyCode == 13){
					String percent = percentage.getText();
					System.out.println(percent);
					//p.setSize(Integer.parseInt(percent));
				}
			}
		});
	}*/
	
	private void initCanvas(){
		canvas.addFocusListener(new FocusListener() {
			
			@Override
			public void focusLost(FocusEvent e) {

			}
			
			@Override
			public void focusGained(FocusEvent e) {
				rootPart.setActive(ImageViewComposite.this);
			}
		});
	}
	
	private void init(){
		//initText();
		initButtons();
		initSlider();
		initCanvas();
	}
	
	public void setTool(AToolFactory factory, String toolname){
		canvas.setTool(factory.createTool(toolname, canvas));
	}
	
	public DicomCanvas getCanvas(){
		return canvas;
	}
	
	public void setActiveCanvas(){
		rootPart.setActive(this);
	}
	
	public String getTitle(){
		return label.getText();
	}
	
	@Override
	protected void checkSubclass() {
		// Disable the check that prevents subclassing of SWT components
	}
}
