package org.jmedikit.lib.io;

import java.io.File;
import java.util.ArrayList;

import javax.inject.Inject;

import org.eclipse.core.runtime.IProgressMonitor;
import org.eclipse.core.runtime.IStatus;
import org.eclipse.core.runtime.Status;
import org.eclipse.core.runtime.jobs.Job;
import org.eclipse.e4.ui.model.application.MApplication;
import org.eclipse.e4.ui.workbench.modeling.EModelService;
import org.jmedikit.lib.core.DicomObject;
import org.jmedikit.lib.core.DicomSeries;
import org.jmedikit.lib.core.DicomStudy;
import org.jmedikit.lib.core.Patient;

public class DicomImporter extends Job{
	
	File importLocation;
	
	private int filenumber;
	
	IProgressMonitor monitor;
	
	private ArrayList<Patient> patients;
	
	public DicomImporter(String jobName, File f){
		super(jobName);
		importLocation = f;
		filenumber = 0;
		//determine filenumber;
		//countFiles(f);
		System.out.println(filenumber);
		patients = new ArrayList<>();
		
		//importDicomFiles();
	}
	
	private void countFiles(File f){
		if(f.isDirectory()){
			File[] files = f.listFiles();
			for(int i = 0; i < files.length; i++){
				if(files[i].isDirectory() && !files[i].isHidden()){
					//System.out.println(files[i].getPath() + " "+filenumber+" "+i);
					countFiles(files[i]);
				}
				else{
					//System.out.println("File "+files[i].getPath()+" "+filenumber);
					filenumber++;
				}
			}
		}
		else{
			filenumber++;
		}
	}
	
	private void importDicomFiles(){
		if(importLocation.isDirectory()){
			File[] files = importLocation.listFiles();
			for(File f : files){
				if(f.isDirectory()){
					importLocation = f;
					importDicomFiles();
				}
				else{
					importDicomObject(f);
					monitor.worked(1);
				}
			}
		}
		else {
			importDicomObject(importLocation);
			monitor.worked(1);
		}
	}
	
	private void importDicomObject(File f){
		try {
			DicomObject obj = new DicomObject(f);
			
			String name = (String) obj.getTagData("PatientName", DicomData.RETURN_STRING);
			String studyId = (String) obj.getTagData("StudyInstanceUID", DicomData.RETURN_STRING);
			String seriesId = (String) obj.getTagData("SeriesInstanceUID", DicomData.RETURN_STRING);
			
			DicomSeries singleSeries = new DicomSeries(seriesId);
			DicomStudy study = new DicomStudy(studyId);
			Patient p = new Patient(name);
			
			if(!patients.contains(p)){
				patients.add(p);
			}
			
			for(Patient patient : patients){
				ArrayList<DicomStudy> std = patient.getDicomStudies();
				if(!std.contains(study) && (patient.getPatientName().equals(p.getPatientName()))){
					patient.addDicomStudy(study);
				}
				for(DicomStudy dcmstudy : std){
					ArrayList<DicomSeries> srs = dcmstudy.getDicomSeries();
					if(!srs.contains(singleSeries) && (dcmstudy.getStudyInstanceUid().equals(study.getStudyInstanceUid()))){
						dcmstudy.addDicomSeries(singleSeries);
					}
					for(DicomSeries dcmsrs : srs){
						ArrayList<DicomObject> dcmobjs = dcmsrs.getDicomObjects();
						if(!dcmobjs.contains(obj) && dcmsrs.getSeriesInstanceUid().equals(singleSeries.getSeriesInstanceUid())){
							dcmsrs.addDicomObject(obj);
						}
					}
				}
			}
		} catch (Exception e) {
			System.out.println("DicomObject is null "+ f.getPath());
			return;
		}
	}
	
	public void printImportedLocation(){
		for(Patient p : patients){
			System.out.println("Patient "+p.getPatientName());
			for(DicomStudy stdy : p.getDicomStudies()){
				System.out.println("\tStudy "+stdy.getStudyInstanceUid());
				for(DicomSeries srs : stdy.getDicomSeries()){
					System.out.println("\t\tSeries "+srs.getSeriesInstanceUid());
					//System.out.println("\t\t\t"+srs.getDicomObjects().size());
					for(DicomObject obj : srs.getDicomObjects()){
						System.out.println("\t\t\t"+obj.getFile().getName()+", Frames: "+obj.getDepth());
					}
				}
			}
		}
	}

	public ArrayList<Patient> getPatients(){
		return patients;
	}
	
	@Override
	protected IStatus run(IProgressMonitor monitor) {
		countFiles(importLocation);
		
		this.monitor = monitor;
		this.monitor.beginTask(this.getName(), filenumber);
		
		this.importDicomFiles();
		monitor.done();
		return Status.OK_STATUS;
	}
}
